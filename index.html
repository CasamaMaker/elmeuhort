<!-- <!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>el Meu Hort</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .header {
      background: white;
      padding: 16px 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1px;
    }
    
    .header h1 {
      font-size: 1.5em;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .tabs-container {
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow-x: auto;
      margin-bottom: 1px;
    }
    
    .tabs {
      display: flex;
      padding: 8px 12px;
      gap: 8px;
      min-width: min-content;
    }
    
    .tabs button {
      padding: 8px 16px;
      background: #f8f9fa;
      color: #666;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .tabs button:hover {
      background: #e9ecef;
      border-color: #999;
    }
    
    .tabs button.active {
      background: #2c3e50;
      color: white;
      border-color: #2c3e50;
    }
    
    .content-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    
    .tab-content {
      display: none;
    }
    
    .action-section {
      margin-bottom: 24px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .action-header {
      font-size: 1.1em;
      font-weight: 600;
      color: white;
      padding: 14px 16px;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      border-bottom: 3px solid #1a252f;
    }
    
    .plant-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      transition: box-shadow 0.2s;
    }
    
    .action-section .plant-card {
      border: none;
      border-radius: 0;
      border-bottom: 1px solid #e8e8e8;
      box-shadow: none;
      margin-bottom: 0;
      padding: 16px;
    }
    
    .action-section .plant-card:last-child {
      border-bottom: none;
    }
    
    .action-section .plant-card:hover {
      background: #f8f9fa;
      box-shadow: none;
    }
    
    .plant-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .plant-card.completed {
      opacity: 0.6;
      background: #f8f9fa;
    }
    
    .plant-card.completed .plant-name {
      text-decoration: line-through;
      color: #999;
    }
    
    .checkbox-container {
      flex-shrink: 0;
      padding-top: 2px;
    }
    
    .checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #2c3e50;
    }
    
    .plant-info {
      flex: 1;
      min-width: 0;
    }
    
    .plant-name {
      font-weight: 600;
      font-size: 0.95em;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .info-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85em;
      color: #666;
    }
    
    .info-item {
      display: flex;
      gap: 4px;
    }

    .info-label {
      font-weight: 500;
      color: #555;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      background: white;
      border-radius: 6px;
    }
    
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.3em;
      }
      
      .content-container {
        padding: 12px;
      }
      
      .plant-card {
        padding: 10px;
      }
      
      .action-section .plant-card {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>el Meu Hort 46</h1>
  </div>
  
  <div class="tabs-container">
    <div class="tabs" id="tabs"></div>
  </div>
  
  <div class="content-container">
    <div class="loading" id="loading">Carregant...</div>
    <div id="tab-contents"></div>
  </div>

  <script>
    const SHEET_ID = "1VmQdVqhokSYiHTfNNg7z4v4fLPePhAD53za76YBJnhg";
    const SHEET_NAME = "Full1";
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;
    
    const mesos = ["Gener","Febrer","Març","Abril","Maig","Juny","Juliol","Agost","Setembre","Octubre","Novembre","Desembre"];
    
    //Columnes
    const planta_col = 0;
    const mes_col = 1;
    const inici_col = 2;
    const final_col = 3;
    const lluna_col = 4;
    const accio_col = 5;
    const tipus_col = 6;
    const notes_col = 7;

    // Càlcul dinàmic de les fases lunars
    function faseLunar(date) {
      const llunaNovaRef = new Date(Date.UTC(2000, 0, 6, 18, 14)); // 6/01/2000 18:14 UTC
      const periodeLunar = 29.53058867; // dies
      const dies = (date - llunaNovaRef) / 86400000;
      const cicle = ((dies % periodeLunar) + periodeLunar) % periodeLunar;
      const fase = cicle / periodeLunar;
      
      if (fase < 0.03 || fase > 0.97) return "nova";
      if (fase < 0.25) return "creixent";
      if (fase < 0.53) return "plena";
      return "minvant";
    }
    
    function getLunarPhaseDay(mes, lluna) {
      if (!lluna) return "";
      
      const llunaLower = lluna.toLowerCase();
      let faseDesitjada = "";
      
      if (llunaLower.includes("plena")) {
        faseDesitjada = "plena";
      } else if (llunaLower.includes("nova")) {
        faseDesitjada = "nova";
      } else if (llunaLower.includes("creixent")) {
        faseDesitjada = "creixent";
      } else if (llunaLower.includes("minvant")) {
        faseDesitjada = "minvant";
      } else {
        return "";
      }
      
      // Obtenir l'índex del mes (0-11)
      const mesIndex = mesos.indexOf(mes);
      if (mesIndex === -1) return "";
      
      const any = 2026; // Any actual
      
      // Buscar el primer dia del mes on coincideix la fase
      for (let dia = 1; dia <= 31; dia++) {
        const data = new Date(any, mesIndex, dia);
        
        // Comprovar que el dia està dins del mes
        if (data.getMonth() !== mesIndex) break;
        
        const faseActual = faseLunar(data);
        
        if (faseActual === faseDesitjada) {
          return dia;
        }
      }
      
      return "";
    }
    
    let completedTasks = {};
  
    function loadCompletedTasks() {
      const data = localStorage.getItem('hort-completed-tasks');
      completedTasks = data ? JSON.parse(data) : {};
    }

    function saveCompletedTasks() {
      localStorage.setItem(
        'hort-completed-tasks',
        JSON.stringify(completedTasks)
      );
    }

    function getTaskId(mes, planta, accio) {
      return `${mes}_${planta}_${accio}`.replace(/\s/g, '_');
    }
    
    function toggleTask(taskId, checkbox) {
      completedTasks[taskId] = checkbox.checked;
      saveCompletedTasks();
      
      const card = checkbox.closest('.plant-card');
      if (checkbox.checked) {
        card.classList.add('completed');
      } else {
        card.classList.remove('completed');
      }
    }
    
    async function init() {
      //Carregar tasques completades
      loadCompletedTasks();
      
      //Petició de dades (Google Sheets publicat)
      fetch(URL + "&t=" + Date.now())
        .then(res => res.text())
        .then(data => {
          //Neteja i parseig del JSON
          const json = JSON.parse(data.substring(47, data.length - 2));
          //Extracció de files de dades
          const rows = json.table.rows.map(r => r.c.map(c => c ? c.v : ""));
          
          //Amagar el missatge de càrrega
          document.getElementById("loading").style.display = "none";
          
          //Creació de les pestanyes (mesos)
          const tabsDiv = document.getElementById("tabs");

          //calcula el mes actual
          const mesActual = new Date().getMonth(); // 0 = Gener, 11 = Desembre

          //crea un botó per cada mes
          mesos.forEach((mes, idx) => {
            const btn = document.createElement("button");
            btn.className = "tab-link";

            //El mes actual queda actiu per defecte
            if (idx === mesActual) btn.classList.add("active");
            btn.textContent = mes;

            //En clicar, es mostra el contingut del mes corresponent.
            btn.onclick = (e) => openMonth(e, mes);
            tabsDiv.appendChild(btn);
          });
          
          //Creació del contingut de cada mes
          const contentDiv = document.getElementById("tab-contents");
          
          mesos.forEach((mes, idx) => {
            
            //Div per cada mes
            const div = document.createElement("div");
            div.id = mes;
            div.className = "tab-content";
            if (idx === mesActual) div.style.display = "block";
            
            //Filtrar files del mes
            const mesRows = rows.filter(r => r[mes_col] === mes);
            
            //Cas sense tasques
            if (mesRows.length === 0) {
              div.innerHTML = `<div class="empty-state">No hi ha tasques per aquest mes</div>`;
            } else {

              //Agrupar per accions (Plantar, Podar, Collir…)
              const accions = [...new Set(mesRows.map(r => r[accio_col]).filter(a => a))];
              
              let html = "";
              
              //Generació de seccions per acció
              accions.forEach(accio => {
                html += `<div class="action-section"><div class="action-header">${accio}</div>`;
                
                //Generació de cada tasca (plant-card)
                mesRows.filter(r => r[accio_col] === accio).forEach(r => {
                  const planta = r[planta_col] || "Sense nom";
                  const lluna = r[lluna_col] || "";
                  const tipus = r[tipus_col] || "";
                  const notes = r[notes_col] || "";
                  
                  //Identificador únic de tasca
                  const taskId = getTaskId(mes, planta, accio);

                  //Estat completat
                  const isCompleted = completedTasks[taskId] || false;
                  
                  // Obtenir el dia de la fase lunar
                  const diaLlunar = getLunarPhaseDay(mes, lluna);
                  const llunaText = diaLlunar ? `${lluna} (dia ${diaLlunar})` : lluna;
                  

                  //HTML final de la targeta
                  html += `
                    <div class="plant-card ${isCompleted ? 'completed' : ''}">
                      <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" 
                               data-task-id="${taskId}"
                               ${isCompleted ? 'checked' : ''}>
                      </div>
                      <div class="plant-info">
                        <div class="plant-name">${planta}</div>
                        <div class="info-row">
                          ${lluna ? `<div class="info-item"><span class="info-label">Lluna:</span> <span>${llunaText}</span></div>` : ''}
                          ${tipus ? `<div class="info-item"><span class="info-label">Tipus plantació:</span> <span>${tipus}</span></div>` : ''}
                          ${notes ? `<div class="info-item"><span class="info-label">Notes:</span> <span>${notes}</span></div>` : ''}
                        </div>
                      </div>
                    </div>
                  `;
                });
                
                html += `</div>`;
              });
              
              div.innerHTML = html;
              
              //Activar els checkboxes
              div.querySelectorAll('.checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                  toggleTask(this.dataset.taskId, this);
                });
              });
            }
            //Afegir el mes al DOM
            contentDiv.appendChild(div);
          });
        })
        //Gestió d'errors
        .catch(err => {
          document.getElementById("loading").textContent = "Error carregant les dades";
          console.error("Error:", err);
        });
    }
   
    function openMonth(evt, monthName) {
      const tabcontent = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      
      const tablinks = document.getElementsByClassName("tab-link");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
      }
      
      document.getElementById(monthName).style.display = "block";
      evt.currentTarget.classList.add("active");
    }
    
    init();
  </script>
</body>
</html> -->
























<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>el Meu Hort</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .header {
      background: white;
      padding: 16px 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1px;
    }
    
    .header h1 {
      font-size: 1.5em;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .tabs-container {
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow-x: auto;
      margin-bottom: 1px;
    }
    
    .tabs {
      display: flex;
      padding: 8px 12px;
      gap: 8px;
      min-width: min-content;
    }
    
    .tabs button {
      padding: 8px 16px;
      background: #f8f9fa;
      color: #666;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .tabs button:hover {
      background: #e9ecef;
      border-color: #999;
    }
    
    .tabs button.active {
      background: #2c3e50;
      color: white;
      border-color: #2c3e50;
    }
    
    .content-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    
    .tab-content {
      display: none;
    }
    
    .action-section {
      margin-bottom: 24px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .action-header {
      font-size: 1.1em;
      font-weight: 600;
      color: white;
      padding: 14px 16px;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      border-bottom: 3px solid #1a252f;
    }
    
    .plant-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      transition: box-shadow 0.2s;
    }
    
    .action-section .plant-card {
      border: none;
      border-radius: 0;
      border-bottom: 1px solid #e8e8e8;
      box-shadow: none;
      margin-bottom: 0;
      padding: 16px;
    }
    
    .action-section .plant-card:last-child {
      border-bottom: none;
    }
    
    .action-section .plant-card:hover {
      background: #f8f9fa;
      box-shadow: none;
    }
    
    .plant-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .plant-card.completed {
      opacity: 0.6;
      background: #f8f9fa;
    }
    
    .plant-card.completed .plant-name {
      text-decoration: line-through;
      color: #999;
    }
    
    .checkbox-container {
      flex-shrink: 0;
      padding-top: 2px;
    }
    
    .checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #2c3e50;
    }
    
    .plant-info {
      flex: 1;
      min-width: 0;
    }
    
    .plant-name {
      font-weight: 600;
      font-size: 0.95em;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .info-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85em;
      color: #666;
    }
    
    .info-item {
      display: flex;
      gap: 4px;
    }

    .info-label {
      font-weight: 500;
      color: #555;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      background: white;
      border-radius: 6px;
    }
    
    .reset-button {
      margin-top: 24px;
      padding: 12px 24px;
      background: white;
      color: #e74c3c;
      border: 2px solid #e74c3c;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.2s;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    
    .reset-button:hover {
      background: #e74c3c;
      color: white;
    }
    
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.3em;
      }
      
      .content-container {
        padding: 12px;
      }
      
      .plant-card {
        padding: 10px;
      }
      
      .action-section .plant-card {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>el Meu Hort 60</h1>
  </div>
  
  <div class="tabs-container">
    <div class="tabs" id="tabs"></div>
  </div>
  
  <div class="content-container">
    <div class="loading" id="loading">Carregant...</div>
    <div id="tab-contents"></div>
  </div>

  <script>
    const SHEET_ID = "1VmQdVqhokSYiHTfNNg7z4v4fLPePhAD53za76YBJnhg";
    const SHEET_NAME = "Full1";
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;
    
    const mesos = ["Gener","Febrer","Març","Abril","Maig","Juny","Juliol","Agost","Setembre","Octubre","Novembre","Desembre"];
    
    //Columnes
    const planta_col = 0;
    const mes_col = 1;
    const inici_col = 2;
    const final_col = 3;
    const lluna_col = 4;
    const accio_col = 5;
    const tipus_col = 6;
    const notes_col = 7;

    // Càlcul dinàmic de les fases lunars
    function faseLunar(date) {
      const llunaNovaRef = new Date(Date.UTC(2000, 0, 6, 18, 14)); // 6/01/2000 18:14 UTC
      const periodeLunar = 29.53058867; // dies
      const dies = (date - llunaNovaRef) / 86400000;
      const cicle = ((dies % periodeLunar) + periodeLunar) % periodeLunar;
      const fase = cicle / periodeLunar;
      
      // if (fase < 0.03 || fase > 0.97) return "nova";
      // if (fase < 0.25) return "creixent";
      // if (fase < 0.53) return "plena";

      if (fase < 0.01 || fase > 0.99) return "nova";
      if (fase >= 0.22 && fase <= 0.45) return "creixent";
      if (fase >= 0.47 && fase <= 0.55) return "plena";
      if (fase >= 0.72 && fase <= 0.80) return "minvant";
      return "";
    }
    
    // function getLunarPhaseDay(mes, lluna) {
    //   let diaInici = null;
    //   let diaFi = null;

    //   if (!lluna) return "";
      
    //   const llunaLower = lluna.toLowerCase();
    //   let faseDesitjada = "";
      
    //   if (llunaLower.includes("plena")) {
    //     faseDesitjada = "plena";
    //   } else if (llunaLower.includes("nova")) {
    //     faseDesitjada = "nova";
    //   } else if (llunaLower.includes("creixent")) {
    //     faseDesitjada = "creixent";
    //   } else if (llunaLower.includes("minvant")) {
    //     faseDesitjada = "minvant";
    //   } else {
    //     return "";
    //   }
      
    //   // Obtenir l'índex del mes (0-11)
    //   const mesIndex = mesos.indexOf(mes);
    //   if (mesIndex === -1) return "";
      
    //   const any = 2026; // Any actual
      
    //   // Buscar el primer dia del mes on coincideix la fase
    //   // for (let dia = 1; dia <= 31; dia++) {
    //   //   const data = new Date(any, mesIndex, dia);
        
    //   //   // Comprovar que el dia està dins del mes
    //   //   if (data.getMonth() !== mesIndex) break;
        
    //   //   const faseActual = faseLunar(data);
        
    //   //   if (faseActual === faseDesitjada) {
    //   //     if (diaInici === null) diaInici = dia;
    //   //     diaFi = dia;
    //   //   } else if (diaInici !== null) {
    //   //     break; // ja hem sortit del rang
    //   //   }
    //   // }

    //   let mesFiIndex = mesIndex; // inicialment igual que mesIndex

    //   for (let dia = 1; dia <= 31; dia++) {
    //     const data = new Date(any, mesIndex, dia);

    //     if (data.getMonth() > mesIndex) break; // si hem passat al mes següent, sortir
        
    //     const faseActual = faseLunar(data);
        
    //     if (faseActual === faseDesitjada) {
    //       if (diaInici === null) diaInici = dia;
    //       diaFi = dia;
    //       mesFiIndex = data.getMonth(); // guardar el mes del dia final
    //     } else if (diaInici !== null) {
    //       break; // ja hem sortit del rang
    //     }
    //   }

    //   if (diaInici === null) return null;

    //   return { 
    //     inici: { mes: mesos[mesIndex], dia: diaInici }, 
    //     fi: { mes: mesos[mesFiIndex], dia: diaFi } 
    //   };
      
    //   return "";
    // }
    
    function getLunarPhaseDay(mes, lluna) {
      if (!lluna) return null;
      
      const llunaLower = lluna.toLowerCase();
      let faseDesitjada = "";
      
      if (llunaLower.includes("plena")) faseDesitjada = "plena";
      else if (llunaLower.includes("nova")) faseDesitjada = "nova";
      else if (llunaLower.includes("creixent")) faseDesitjada = "creixent";
      else if (llunaLower.includes("minvant")) faseDesitjada = "minvant";
      else return null;
      
      const any = 2026;
      let diaInici = null;
      let diaFi = null;
      const mesIndex = mesos.indexOf(mes);
      if (mesIndex === -1) return null;

      // marge de seguretat: 7 dies abans i després
      const dataInici = new Date(any, mesIndex, 1);
      const dataFi = new Date(any, mesIndex + 1, 7);


      // // Iterar tots els dies de l'any
      // for (let m = 0; m < 12; m++) {
      //   for (let d = 1; d <= 31; d++) {
      //     const data = new Date(any, m, d);
      //     if (data.getMonth() !== m) break; // dia fora del mes
          
      //     const faseActual = faseLunar(data);
          
      //     if (faseActual === faseDesitjada) {
      //       if (!diaInici) diaInici = { mes: mesos[m], dia: d };
      //       diaFi = { mes: mesos[m], dia: d };
      //     } else if (diaInici) {
      //       break; // hem sortit del rang
      //     }
      //   }
      //   if (diaInici && diaFi) break;
      // }

      let cursor = new Date(dataInici);

      while (cursor <= dataFi) {
        const faseActual = faseLunar(cursor);

        if (faseActual === faseDesitjada) {
          if (!diaInici) {
            diaInici = {
              dia: cursor.getDate(),
              mes: mesos[cursor.getMonth()]
            };
          }
          diaFi = {
            dia: cursor.getDate(),
            mes: mesos[cursor.getMonth()]
          };
        } else if (diaInici) {
          break;
        }

        cursor.setDate(cursor.getDate() + 1);
      }


      if (!diaInici) return null;
      
      return { inici: diaInici, fi: diaFi };
    }


    let completedTasks = {};
  
    function loadCompletedTasks() {
      const data = localStorage.getItem('hort-completed-tasks');
      completedTasks = data ? JSON.parse(data) : {};
    }

    function saveCompletedTasks() {
      localStorage.setItem(
        'hort-completed-tasks',
        JSON.stringify(completedTasks)
      );
    }

    function getTaskId(mes, planta, accio) {
      return `${mes}_${planta}_${accio}`.replace(/\s/g, '_');
    }
    
    function toggleTask(taskId, checkbox) {
      completedTasks[taskId] = checkbox.checked;
      saveCompletedTasks();
      
      const card = checkbox.closest('.plant-card');
      if (checkbox.checked) {
        card.classList.add('completed');
      } else {
        card.classList.remove('completed');
      }
    }
    
    function resetAllTasks(monthName) {
      const monthDiv = document.getElementById(monthName);
      const checkboxes = monthDiv.querySelectorAll('.checkbox');
      
      checkboxes.forEach(checkbox => {
        const taskId = checkbox.dataset.taskId;
        checkbox.checked = false;
        delete completedTasks[taskId];
        
        const card = checkbox.closest('.plant-card');
        card.classList.remove('completed');
      });
      
      saveCompletedTasks();
    }
    
    async function init() {
      //Carregar tasques completades
      loadCompletedTasks();
      
      //Petició de dades (Google Sheets publicat)
      fetch(URL + "&t=" + Date.now())
        .then(res => res.text())
        .then(data => {
          //Neteja i parseig del JSON
          const json = JSON.parse(data.substring(47, data.length - 2));
          //Extracció de files de dades
          const rows = json.table.rows.map(r => r.c.map(c => c ? c.v : ""));
          
          //Amagar el missatge de càrrega
          document.getElementById("loading").style.display = "none";
          
          //Creació de les pestanyes (mesos)
          const tabsDiv = document.getElementById("tabs");

          //calcula el mes actual
          const mesActual = new Date().getMonth(); // 0 = Gener, 11 = Desembre

          //crea un botó per cada mes
          mesos.forEach((mes, idx) => {
            const btn = document.createElement("button");
            btn.className = "tab-link";

            //El mes actual queda actiu per defecte
            if (idx === mesActual) btn.classList.add("active");
            btn.textContent = mes;

            //En clicar, es mostra el contingut del mes corresponent.
            btn.onclick = (e) => openMonth(e, mes);
            tabsDiv.appendChild(btn);
          });
          
          //Creació del contingut de cada mes
          const contentDiv = document.getElementById("tab-contents");
          
          mesos.forEach((mes, idx) => {
            
            //Div per cada mes
            const div = document.createElement("div");
            div.id = mes;
            div.className = "tab-content";
            if (idx === mesActual) div.style.display = "block";
            
            //Filtrar files del mes
            const mesRows = rows.filter(r => r[mes_col] === mes);
            
            //Cas sense tasques
            if (mesRows.length === 0) {
              div.innerHTML = `<div class="empty-state">No hi ha tasques per aquest mes</div>`;
            } else {

              //Agrupar per accions (Plantar, Podar, Collir…)
              const accions = [...new Set(mesRows.map(r => r[accio_col]).filter(a => a))];
              
              let html = "";
              
              //Generació de seccions per acció
              accions.forEach(accio => {
                html += `<div class="action-section"><div class="action-header">${accio}</div>`;
                
                //Generació de cada tasca (plant-card)
                mesRows.filter(r => r[accio_col] === accio).forEach(r => {
                  const planta = r[planta_col] || "Sense nom";
                  const lluna = r[lluna_col] || "";
                  const tipus = r[tipus_col] || "";
                  const notes = r[notes_col] || "";
                  
                  //Identificador únic de tasca
                  const taskId = getTaskId(mes, planta, accio);

                  //Estat completat
                  const isCompleted = completedTasks[taskId] || false;
                  
                  // Obtenir el dia de la fase lunar
                  // const diaLlunar = getLunarPhaseDay(mes, lluna);
                  // const llunaText = diaLlunar ? `${lluna} (dia ${diaLlunar})` : lluna;
                  const rangLlunar = getLunarPhaseDay(mes, lluna);
                  let llunaText = lluna;

                  if (rangLlunar) {
                    // if (rangLlunar.inici === rangLlunar.fi) {
                    if (
                      rangLlunar.inici.dia === rangLlunar.fi.dia &&
                      rangLlunar.inici.mes === rangLlunar.fi.mes
                    ) {
                      // llunaText = `${lluna} (dia ${rangLlunar.inici})`;
                      llunaText = `${lluna} (dia ${rangLlunar.inici.dia} ${rangLlunar.inici.mes})`;
                    } else {
                      // llunaText = `${lluna} (dies ${rangLlunar.inici}–${rangLlunar.fi})`;
                      if (rangLlunar.inici.mes === rangLlunar.fi.mes) {
                        llunaText = `${lluna} (dies ${rangLlunar.inici.dia}–${rangLlunar.fi.dia} ${rangLlunar.inici.mes})`;
                      } else {
                        llunaText = `${lluna} (dies ${rangLlunar.inici.dia} ${rangLlunar.inici.mes} – ${rangLlunar.fi.dia} ${rangLlunar.fi.mes})`;
                      }

                    }
                  }

                  

                  //HTML final de la targeta
                  html += `
                    <div class="plant-card ${isCompleted ? 'completed' : ''}">
                      <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" 
                               data-task-id="${taskId}"
                               ${isCompleted ? 'checked' : ''}>
                      </div>
                      <div class="plant-info">
                        <div class="plant-name">${planta}</div>
                        <div class="info-row">
                          ${lluna ? `<div class="info-item"><span class="info-label">Lluna:</span> <span>${llunaText}</span></div>` : ''}
                          ${tipus ? `<div class="info-item"><span class="info-label">Tipus plantació:</span> <span>${tipus}</span></div>` : ''}
                          ${notes ? `<div class="info-item"><span class="info-label">Notes:</span> <span>${notes}</span></div>` : ''}
                        </div>
                      </div>
                    </div>
                  `;
                });
                
                html += `</div>`;
              });
              
              // Afegir botó per reiniciar
              html += `<button class="reset-button" onclick="resetAllTasks('${mes}')">Desmarcar tot</button>`;
              
              div.innerHTML = html;
              
              //Activar els checkboxes
              div.querySelectorAll('.checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                  toggleTask(this.dataset.taskId, this);
                });
              });
            }
            //Afegir el mes al DOM
            contentDiv.appendChild(div);
          });
        })
        //Gestió d'errors
        .catch(err => {
          document.getElementById("loading").textContent = "Error carregant les dades";
          console.error("Error:", err);
        });
    }
   
    function openMonth(evt, monthName) {
      const tabcontent = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      
      const tablinks = document.getElementsByClassName("tab-link");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
      }
      
      document.getElementById(monthName).style.display = "block";
      evt.currentTarget.classList.add("active");
    }
    
    init();
  </script>
</body>
</html>